---
name: supabase-setup
description: Wire Supabase to the Next.js web app, SwiftUI iOS app, and Jetpack Compose Android app. Use when the user says "add Supabase", "set up the database", "connect to Supabase", or "add auth". Installs the JS client, creates typed client helpers, scaffolds the Swift and Kotlin clients, and creates all config files on all three platforms.
disable-model-invocation: true
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
metadata:
  mcp-server: supabase
---

# Supabase Setup

Wire Supabase to Next.js, SwiftUI, and Jetpack Compose in one coordinated workflow.

## Arguments

`$ARGUMENTS` — Optional: Supabase project reference ID (e.g. `abcdefghijklmnop`).
If not provided, scaffold client code only without linking to a live project.

## Workflow

### Phase 1: Prerequisites Check

```bash
supabase --version 2>/dev/null || echo "CLI_MISSING: brew install supabase/tap/supabase"
ls supabase/config.toml 2>/dev/null || echo "TOML_MISSING: run supabase init"
ls multi-repo-nextjs/node_modules/@supabase 2>/dev/null || echo "NPM_MISSING"
```

### Phase 2: Supabase CLI Link (if project ref provided)

If `$ARGUMENTS` contains a project ref:

```bash
supabase link --project-ref $ARGUMENTS
```

### Phase 3: Install Next.js Supabase Packages

```bash
cd multi-repo-nextjs && npm install @supabase/supabase-js @supabase/ssr
```

Create directory structure:

```bash
mkdir -p multi-repo-nextjs/lib/supabase
```

Create `multi-repo-nextjs/lib/supabase/client.ts` from
[templates/supabase-client.ts.template](templates/supabase-client.ts.template).

Create `multi-repo-nextjs/lib/supabase/server.ts`:

```typescript
// lib/supabase/server.ts — server-side client for Next.js App Router (RSC + Server Actions)
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import type { Database } from '@/lib/database.types'

export async function createClient() {
  const cookieStore = await cookies()
  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Server Component — cookies can only be set in Server Actions / Route Handlers
          }
        },
      },
    }
  )
}
```

Create `multi-repo-nextjs/.env.local.example`:

```
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

### Phase 4: TypeScript Types

If linked to a live project:

```bash
supabase gen types typescript --linked > multi-repo-nextjs/lib/database.types.ts
```

If not linked, create `multi-repo-nextjs/lib/database.types.ts` placeholder:

```typescript
// database.types.ts — Auto-generated by Supabase CLI.
// Regenerate: supabase gen types typescript --linked > lib/database.types.ts

export type Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]

export type Database = {
  public: {
    Tables: {
      // Tables appear here after: supabase gen types typescript --linked
    }
    Views: Record<string, never>
    Functions: Record<string, never>
    Enums: Record<string, never>
    CompositeTypes: Record<string, never>
  }
}

export type Tables<T extends keyof Database['public']['Tables']> =
  Database['public']['Tables'][T]['Row']
export type Enums<T extends keyof Database['public']['Enums']> =
  Database['public']['Enums'][T]
```

### Phase 5: iOS Swift Client Scaffold

Create directory:

```bash
mkdir -p multi-repo-ios/multi-repo-ios/Supabase
mkdir -p multi-repo-ios/multi-repo-ios/Models
```

Create `multi-repo-ios/multi-repo-ios/Supabase/Config.swift`:

```swift
// Config.swift — Supabase credentials
// Set SUPABASE_URL and SUPABASE_ANON_KEY in Xcode scheme environment variables.
// Never commit real credentials to source control.
import Foundation

enum SupabaseConfig {
    static let url = URL(string:
        ProcessInfo.processInfo.environment["SUPABASE_URL"]
        ?? "https://your-project-ref.supabase.co"
    )!
    static let anonKey: String =
        ProcessInfo.processInfo.environment["SUPABASE_ANON_KEY"]
        ?? "your-anon-key-here"
}
```

Create `multi-repo-ios/multi-repo-ios/Supabase/SupabaseManager.swift` from
[templates/SupabaseClient.swift.template](templates/SupabaseClient.swift.template).

### Phase 6: Android Supabase Client Scaffold

Check if the Android project exists:
```bash
find multi-repo-android/app/src/main/java -name "*.kt" | head -3 2>/dev/null || echo "Android not found"
```

If found, determine the base package and create the following files.

> **Note:** supabase-kt is already in `gradle/libs.versions.toml` (version 3.2.5) with postgrest, realtime, auth, and compose-auth modules. Ktor client is also configured.

Create `multi-repo-android/app/src/main/java/<base-package>/data/remote/SupabaseConfig.kt`:

```kotlin
// SupabaseConfig.kt — Supabase credentials
// Set SUPABASE_URL and SUPABASE_ANON_KEY in local.properties (not committed to git).
// BuildConfig fields are generated by Gradle from local.properties.
package <base.package>.data.remote

object SupabaseConfig {
    // TODO: Wire these from BuildConfig after adding to build.gradle.kts:
    //   val supabaseUrl: String by project.extra
    //   buildConfigField("String", "SUPABASE_URL", "\"$supabaseUrl\"")
    val url: String = "" // BuildConfig.SUPABASE_URL
    val anonKey: String = "" // BuildConfig.SUPABASE_ANON_KEY
}
```

Create `multi-repo-android/app/src/main/java/<base-package>/data/remote/SupabaseModule.kt`:

```kotlin
// SupabaseModule.kt — Hilt DI module for Supabase client
package <base.package>.data.remote

import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import io.github.jan.supabase.SupabaseClient
import io.github.jan.supabase.createSupabaseClient
import io.github.jan.supabase.postgrest.Postgrest
import io.github.jan.supabase.auth.Auth
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object SupabaseModule {

    @Provides
    @Singleton
    fun provideSupabaseClient(): SupabaseClient {
        return createSupabaseClient(
            supabaseUrl = SupabaseConfig.url,
            supabaseKey = SupabaseConfig.anonKey,
        ) {
            install(Postgrest)
            install(Auth)
        }
    }
}
```

Create `multi-repo-android/local.properties.example` (if not already present):
```
# Supabase credentials — copy to local.properties and fill in real values
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
```

If the Android project does not exist, skip this phase and note it in the summary.

### Phase 7: Update All CLAUDE.md Files

Append to `multi-repo-nextjs/CLAUDE.md`:

```markdown
## Supabase

- Types: `supabase gen types typescript --linked > lib/database.types.ts`
- New migration: `supabase migration new <name>` then `supabase db push`
- Local stack: `supabase start` (requires Docker) → Studio at http://localhost:54323
- Client: `lib/supabase/client.ts` (browser), `lib/supabase/server.ts` (RSC / Server Actions)
```

Append to `multi-repo-ios/CLAUDE.md`:

```markdown
## Supabase Swift SDK (SPM)

Add via Xcode → File → Add Package Dependencies:
URL: https://github.com/supabase/supabase-swift
Version: Up To Next Major from 2.0.0 — Target: multi-repo-ios

Set Xcode scheme environment variables (not in code):
- SUPABASE_URL
- SUPABASE_ANON_KEY
```

If Android project exists, append to `multi-repo-android/CLAUDE.md`:

```markdown
## Supabase (supabase-kt)

Already in gradle/libs.versions.toml (v3.2.5). Modules: postgrest-kt, realtime-kt, auth-kt, compose-auth.

- Client: `data/remote/SupabaseModule.kt` (Hilt singleton)
- Config: `data/remote/SupabaseConfig.kt` (reads from BuildConfig)
- Credentials: Set in `local.properties` (never committed)
```

### Phase 8: Summary

```
## Supabase Setup Complete

Next.js:
  ✓ @supabase/supabase-js + @supabase/ssr installed
  ✓ lib/supabase/client.ts (browser client)
  ✓ lib/supabase/server.ts (SSR client for App Router)
  ✓ lib/database.types.ts (placeholder / generated)
  ✓ .env.local.example created

iOS:
  ✓ Supabase/Config.swift (reads from Xcode env vars)
  ✓ Supabase/SupabaseManager.swift (scaffold — uncomment after SPM add)

Android:
  ✓ data/remote/SupabaseConfig.kt (reads from BuildConfig)
  ✓ data/remote/SupabaseModule.kt (Hilt DI module)
  ✓ local.properties.example created

Manual steps required:
  1. Copy .env.local.example → .env.local and fill in real credentials
  2. In Xcode: File → Add Package Dependencies → supabase-swift (URL above)
  3. In Xcode: Edit Scheme → Run → Arguments → Environment Variables:
     SUPABASE_URL = https://your-project-ref.supabase.co
     SUPABASE_ANON_KEY = your-anon-key-here
  4. Uncomment // import Supabase and client init in SupabaseManager.swift
  5. Android: copy local.properties.example → local.properties, fill in credentials
  6. Android: wire BuildConfig fields in app/build.gradle.kts
  7. Run: supabase gen types typescript --linked > multi-repo-nextjs/lib/database.types.ts
```
