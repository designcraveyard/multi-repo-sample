# /asset-iterate — Iterate and refine generated assets

## Description

Targeted iteration loop for assets previously generated by `/asset-gen`. Reads the asset manifest, asks focused questions to understand what needs to change, then decides whether to run prompt refinement (rewrite the brief and regenerate) or variation generation (same prompt, different seeds). Saves new versions alongside originals with incremented version numbers.

## Trigger

User says "/asset-iterate" or "iterate on the assets" or "refine the illustration" or "regenerate the icon"

## Prerequisites

- `assets/generated/manifest.json` must exist (run `/asset-gen` first)
- `docs/design/asset-brief.md` must exist
- `.env.local` at workspace root must contain `OPENAI_API_KEY=sk-...`

## Instructions

### Step 1: Show current state

Read `assets/generated/manifest.json` and present a table of all current assets:

```
Current assets (v = version, ✓ = approved, ? = pending review):

  #   Asset                          Category        Version   File
  1   App Icon                       app-icon        v1        assets/generated/app-icon/app-icon-v1.png
  2   Empty State — Notes            empty-states    v1        assets/generated/empty-states/empty-state-notes-v1.png
  3   Onboarding — Step 1            onboarding      v2        assets/generated/onboarding/onboarding-step-1-v2.png
  ...
```

Ask: "Which asset(s) would you like to work on? You can name them by number, ID, or describe them."

### Step 2: Understand what needs to change

For each selected asset, ask focused questions. Keep it conversational — 2-3 questions maximum per asset.

**Understand the feedback first:**
"What specifically isn't working about this asset?"

Listen for signal words and route accordingly:

**Route A — Variation (same direction, different execution):**
Triggered by: "not sure", "want to see options", "maybe something slightly different", "explore", "pick the best one"
→ Generate 3 variations with same prompt, no refinement

**Route B — Prompt refinement (direction is off):**
Triggered by: specific critique ("too dark", "too busy", "wrong style", "doesn't feel right", "needs to be more X"), structural feedback, or style mismatch
→ Rewrite the prompt based on feedback, then generate

**Route C — Reference-guided refinement:**
Triggered by: user says "here's what I mean" or drops a new image
→ Extract signals from new reference via Claude vision, incorporate into prompt, then generate (image-to-image if appropriate)

Ask clarifying questions based on the route:

**For Route B (prompt refinement):**
- "What should it feel like instead — can you describe in 2-3 adjectives?"
- "Is it the overall style, the subject matter, the colors, or the composition?"
- "Should it be more [simpler / complex / bright / muted / playful / serious]?"

**For Route C (reference-guided):**
- Analyze the shared image with Claude vision
- Report extracted signals back: "From this reference I'm getting: [signals]"
- "Should I use this as a direct visual reference (image-to-image) or just use it to inform the text prompt?"

### Step 3: Build iteration spec

For each asset being iterated:

**Route A — Variations:**
```json
{
  "mode": "variations",
  "assetId": "empty-state-notes",
  "sourcePrompt": "<original prompt from manifest>",
  "count": 3,
  "outputPaths": [
    "assets/generated/empty-states/empty-state-notes-v2a.png",
    "assets/generated/empty-states/empty-state-notes-v2b.png",
    "assets/generated/empty-states/empty-state-notes-v2c.png"
  ]
}
```

**Route B — Prompt refinement:**
Show the rewritten prompt to the user before running:
"Here's my updated prompt — does this capture the direction better?"

```json
{
  "mode": "refinement",
  "assetId": "empty-state-notes",
  "originalPrompt": "<original>",
  "revisedPrompt": "<rewritten prompt incorporating feedback>",
  "changeLog": "Shifted from busy scene to sparse minimal composition; removed character, kept abstract book metaphor; darkened background to match dark mode palette",
  "outputPath": "assets/generated/empty-states/empty-state-notes-v2.png"
}
```

**Route C — Reference-guided:**
```json
{
  "mode": "reference-guided",
  "assetId": "app-icon",
  "revisedPrompt": "<prompt incorporating extracted signals>",
  "referenceImage": "path/to/user-shared-reference.png",
  "referenceWeight": 0.7,
  "outputPath": "assets/generated/app-icon/app-icon-v2.png"
}
```

### Step 4: Run iteration

Write iteration spec to `/tmp/asset-iterate-spec.json` and run:

```bash
node .claude/plugins/asset-gen/iterate.js --spec /tmp/asset-iterate-spec.json --env .env.local
```

The script outputs generated files and updates `manifest.json` with the new version entries.

### Step 5: Review and decide

For variations (Route A), present the three outputs:
"Here are 3 variations. Which feels closest? (or describe what you'd combine from them)"

For refinements (Routes B/C), present the single new version:
"Here's the new version. Better? Or should we go another round?"

Based on response:
- User approves → mark asset as approved in manifest, move on
- User wants another round → loop back to Step 2 with the new version as current
- User wants to compare old vs new → note both paths from manifest

### Step 6: Finalize

After all selected assets are iterated and approved:

1. Update `assets/generated/manifest.json` — set `"approved": true` on confirmed versions
2. Update `docs/design/asset-brief.md` — append an iteration log section:

```markdown
## Iteration Log

| Asset | Date | Route | Change | Version |
|-------|------|-------|--------|---------|
| Empty State — Notes | 2026-03-01 | Prompt refinement | Removed character, simplified composition | v1 → v2 |
```

3. Offer post-iteration options (same as `/asset-gen` Step 6):
   - Update code references to point at new approved version
   - Push updated asset to Figma
   - Skip

Print summary:
```
## Iteration Report

Assets updated:
- empty-state-notes: v1 → v2 (prompt refinement) ✓ approved
- app-icon: 3 variations generated → v2a selected ✓ approved

Manifest updated: assets/generated/manifest.json
Brief iteration log updated: docs/design/asset-brief.md
```
